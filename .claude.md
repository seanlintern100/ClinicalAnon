# Redactor (ClinicalAnon) - Claude Project Context

## Project Overview

**Project Name:** Redactor
**App Name:** ClinicalAnon (clinical text anonymization tool)
**Type:** macOS native application (SwiftUI)
**Purpose:** Clinical text anonymization tool for psychology and wellbeing practitioners
**Organization:** 3 Big Things
**Target OS:** macOS 13 (Ventura) or later
**Distribution:** Direct download
**Xcode Project:** Redactor.xcodeproj (generated via xcodegen CLI)

### Core Mission
Privacy-first clinical note anonymization using local AI (Ollama + Llama 3.1 8B). No cloud, no internet after setup, all in-memory processing. AI-assisted with human oversight.

---

## Project Structure

```
Redactor/
├── .claude.md (this file)
├── .gitignore
├── README.md
├── project.yml (xcodegen configuration - regenerates Xcode project)
├── Redactor.xcodeproj/ (generated from project.yml - DO NOT edit manually)
│   ├── project.pbxproj
│   └── xcshareddata/xcschemes/Redactor.xcscheme
├── setup-fonts.sh (downloads fonts from Google Fonts)
├── create-xcode-project.sh (project setup helper)
├── docs/
│   ├── ClinicalAnon-Complete-Specification.md (comprehensive spec - 140KB)
│   ├── Implementation-Plan.md (phase-by-phase development plan)
│   ├── Phase-Documents-Checklist.md (all files to create)
│   ├── PHASE-1-SETUP-GUIDE.md (detailed Xcode setup)
│   └── XCODE-SETUP-SIMPLE.md (quick setup guide)
└── ClinicalAnon/ (source code folder)
    ├── ClinicalAnonApp.swift (main app entry)
    ├── Views/
    │   └── Components/
    ├── ViewModels/
    ├── Models/
    ├── Services/
    ├── Utilities/
    │   ├── DesignSystem.swift (brand system)
    │   └── AppError.swift (error handling)
    ├── Resources/
    │   ├── Fonts/ (6 TTF files - Lora + Source Sans 3)
    │   ├── Assets.xcassets/
    │   └── Info.plist
    ├── Preview Content/
    └── Tests/
```

---

## Key Documents

### Primary References
1. **ClinicalAnon-Complete-Specification.md** - Complete product specification (authoritative source)
2. **docs/Implementation-Plan.md** - Phase-by-phase implementation plan
3. **docs/Phase-Documents-Checklist.md** - Every file to create, organized by phase

### Reading Order for Context
1. Start with Implementation-Plan.md for overview and current phase
2. Refer to Phase-Documents-Checklist.md for specific files needed
3. Consult main spec for detailed requirements

---

## Development Approach

### Philosophy
- **Get it right the first time** - Thorough implementation at each stage
- **No revisiting foundations** - Complete design system and architecture from start
- **Phase-by-phase validation** - Verify each phase works before proceeding
- **Manual testing focus** - Developer tests at each phase, minimal automated tests for MVP

### Implementation Phases
1. **PHASE 1:** Project Setup & Design System (CURRENT)
2. **PHASE 2:** Setup Flow & Ollama Integration
3. **PHASE 3:** Core Data Models
4. **PHASE 4:** Business Logic - Services
5. **PHASE 5:** UI Components
6. **PHASE 6:** Main App View
7. **PHASE 7:** Real Ollama Integration
8. **PHASE 8:** Polish & Edge Cases
9. **PHASE 9:** Testing & Validation
10. **PHASE 10:** Deployment Preparation

**Current Status:** ✅ Phase 1 Complete - Xcode project created and building

---

## CLI Approach & Commands

### Project Generation (xcodegen)

This project uses **xcodegen** to generate the Xcode project from a YAML configuration file. This allows:
- Version control of project structure (project.yml)
- Automatic project regeneration
- Consistency across team members
- No manual Xcode project editing

#### Key Files
- **project.yml** - Project configuration (targets, files, settings)
- **Redactor.xcodeproj/** - Generated Xcode project (DO NOT edit manually)

#### Regenerate Project
```bash
# Regenerate Xcode project from project.yml
xcodegen generate

# Clean and regenerate (if you have build issues)
rm -rf Redactor.xcodeproj
rm -rf ~/Library/Developer/Xcode/DerivedData/Redactor-*
xcodegen generate
```

**When to regenerate:**
- After adding new Swift files
- After modifying project.yml
- After changing build settings
- If project file becomes corrupted

### Build Commands (xcodebuild)

```bash
# Build the project
xcodebuild -project Redactor.xcodeproj -scheme Redactor -configuration Debug build

# Build and show only errors/warnings
xcodebuild -project Redactor.xcodeproj -scheme Redactor build 2>&1 | grep -E "(error|warning)"

# Clean build
xcodebuild -project Redactor.xcodeproj -scheme Redactor clean

# Build for release
xcodebuild -project Redactor.xcodeproj -scheme Redactor -configuration Release build
```

### Project Management

```bash
# Open project in Xcode
open Redactor.xcodeproj

# Open specific file in Xcode
open -a Xcode ClinicalAnon/Utilities/DesignSystem.swift

# List all schemes
xcodebuild -project Redactor.xcodeproj -list

# Show build settings
xcodebuild -project Redactor.xcodeproj -scheme Redactor -showBuildSettings
```

### Font Management

```bash
# Download fonts automatically
./setup-fonts.sh

# Fonts are downloaded to:
# ClinicalAnon/Resources/Fonts/
#   - Lora-Regular.ttf
#   - Lora-Bold.ttf
#   - Lora-Italic.ttf
#   - SourceSans3-Regular.ttf
#   - SourceSans3-SemiBold.ttf
#   - SourceSans3-Bold.ttf
```

### Development Workflow

```bash
# 1. Make code changes
# Edit Swift files in ClinicalAnon/

# 2. If you added new files, regenerate project
xcodegen generate

# 3. Build to check for errors
xcodebuild -project Redactor.xcodeproj -scheme Redactor build

# 4. Open in Xcode to run and test
open Redactor.xcodeproj
# Then press Cmd+R to run

# 5. Commit changes
git add .
git commit -m "Your commit message"
git push origin main
```

### Automation Scripts

**setup-fonts.sh**
- Downloads fonts from Google Fonts GitHub
- Verifies file sizes
- Places in correct directory

**create-xcode-project.sh**
- Verifies project structure
- Creates necessary directories
- Opens Xcode for you
- Interactive setup guide

### Important Notes

⚠️ **Never edit Redactor.xcodeproj manually**
- Always use `xcodegen generate` to update the project
- Edit project.yml instead

⚠️ **Source folder is "ClinicalAnon"**
- Project name is "Redactor"
- App name is "ClinicalAnon"
- Source files are in ClinicalAnon/ folder
- This is intentional for file path consistency

⚠️ **Clean build if switching branches**
```bash
rm -rf ~/Library/Developer/Xcode/DerivedData/Redactor-*
xcodegen generate
```

---

## Coding Standards

### Architecture
- **Pattern:** MVVM (Model-View-ViewModel)
- **Dependency Injection:** Protocol-oriented with DI
- **Concurrency:** Swift async/await, @MainActor for UI
- **No 3rd-party dependencies:** Pure Swift/SwiftUI only

### Naming Conventions
- **Variables/Properties:** camelCase (`anonymizedText`, `isProcessing`)
- **Functions:** camelCase, verb-based (`anonymizeText()`, `checkOllamaStatus()`)
- **Types:** PascalCase (`AnonymizationEngine`, `EntityType`)
- **Constants:** camelCase with descriptive names (`defaultTimeout`)

### File Organization
```swift
// MARK: - Properties
// Published properties first, then State, then regular

// MARK: - Initialization

// MARK: - Public Methods

// MARK: - Private Methods

// MARK: - Helper Functions
```

### Code Style
- **Clarity over brevity** - Readable, self-documenting code
- **Explicit types** where helpful for clarity
- **Guard statements** for early returns
- **Comprehensive error handling** with user-friendly messages
- **Comments** for complex logic, not obvious code

---

## Design System

### Brand Colors
- **Primary Teal:** #0A6B7C (professional, trustworthy)
- **Sage:** #A9C1B5 (calm, clinical)
- **Orange:** #E68A2E (energy, action)
- **Sand:** #E8D4BC / #D4AE80 (warmth)
- **Charcoal:** #2E2E2E (text, contrast)
- **Warm White:** #FAF7F4 (backgrounds)

### Typography
- **Headings:** Lora (serif) - warm, professional
- **Body:** Source Sans 3 (sans-serif) - clean, readable
- **Monospace:** SF Mono (system) - for clinical notes

### Spacing Scale
xs: 4pt | small: 8pt | medium: 16pt | large: 24pt | xlarge: 32pt | xxlarge: 48pt

---

## Key Technical Decisions

### Privacy Model
- **Nothing ever written to disk** - pure in-memory processing
- No temp files, no logs, no cache files
- Original and anonymized text held only in RAM while app open
- On app quit: all memory automatically cleared

### Ollama Integration
- **NOT bundled** - User installs separately via Homebrew
- App detects, guides installation, triggers downloads
- Can auto-start Ollama service
- Mock mode for development without Ollama

### Entity Consistency
- Same entity always maps to same code within session
- Example: "Jane Smith" → `[CLIENT_A]` everywhere
- Counter resets on "Clear All" or app close
- Separate counters per entity type

### Replacement Strategy
- Generic codes: `[CLIENT_A]`, `[PROVIDER_A]`, `[LOCATION_A]`, etc.
- Clinical context preserved: ages, genders, diagnoses, symptoms stay
- Relative timeframes preserved: "early 2024", "6 months ago" stay
- Specific PII replaced: names, addresses, exact dates, identifiers

---

## Critical Requirements

### Must Have
- ✅ 100% local processing (no cloud, no internet after setup)
- ✅ Human oversight (review before applying)
- ✅ Consistent entity mapping within session
- ✅ Clinical context preservation
- ✅ Te reo Māori competence
- ✅ Nothing saved to disk
- ✅ Clear visual feedback (highlighting)
- ✅ Editable output (practitioner can refine)

### Must NOT Do
- ❌ Never auto-anonymize without review
- ❌ Never save to disk (no persistence)
- ❌ Never upload to cloud
- ❌ Never create false information
- ❌ Never remove clinical meaning

---

## Development Workflow

### Before Starting Each Phase
1. Read Implementation-Plan.md for phase goals
2. Review Phase-Documents-Checklist.md for files needed
3. Check spec for detailed requirements
4. Update TodoWrite with phase tasks

### During Phase Development
1. Create all files per checklist
2. Implement thoroughly (get it right first time)
3. Use DesignSystem constants (never hard-code values)
4. Follow naming conventions strictly
5. Add MARK comments for organization

### After Completing Each Phase
1. Run through phase verification checklist
2. Manual testing by developer
3. Update Phase-Documents-Checklist.md with completion marks
4. Update TodoWrite to mark phase complete
5. Get explicit approval before next phase

---

## Testing Strategy

### Manual Testing Focus
- Developer performs manual testing at each phase
- Follow verification checklists in Implementation-Plan.md
- Test happy path and error cases
- Validate UI/UX feels right

### Automated Testing (Minimal for MVP)
- Unit tests for core services (Phase 9)
- Focus on EntityMapper, AnonymizationEngine
- JSON parsing validation
- No extensive UI testing for MVP

---

## Common Patterns

### Error Handling
```swift
do {
    let result = try await service.performOperation()
    // Handle success
} catch let error as AppError {
    handleError(error) // User-friendly message
} catch {
    handleError(.unknownError(error))
}
```

### Async Operations
```swift
@MainActor
func analyze() async {
    isProcessing = true
    defer { isProcessing = false }

    do {
        let result = try await engine.anonymizeText(originalText)
        // Update UI on main actor automatically
    } catch {
        handleError(error)
    }
}
```

### Dependency Injection
```swift
class ViewModel: ObservableObject {
    private let service: ServiceProtocol

    init(service: ServiceProtocol = RealService()) {
        self.service = service
    }
}
```

---

## Ollama Integration Notes

### Setup Detection Flow
1. Check Homebrew installed → guide if not
2. Check Ollama installed → guide if not
3. Check Ollama running → auto-start if not
4. Check model downloaded → trigger download if not
5. Ready → proceed to main app

### API Endpoint
- **URL:** http://localhost:11434/api/generate
- **Method:** POST
- **Request:** JSON with model, prompt, options
- **Response:** JSON with anonymized text and entities
- **Timeout:** 30 seconds

### Mock Mode
- Toggle in OllamaService for development
- Returns realistic fake anonymized text
- Simulates entity detection
- Allows UI development without Ollama

---

## File Creation Guidelines

### When Creating New Files
1. Check Phase-Documents-Checklist.md for file location
2. Use proper header comment block
3. Follow architecture pattern (MVVM)
4. Use DesignSystem for all UI values
5. Add to appropriate Xcode group
6. Mark file as complete in checklist

### Import Order
```swift
import SwiftUI      // UI framework
import Combine      // If needed
import Foundation   // Standard library
// Custom imports last
```

---

## Priority Reminders

### Always
- Use DesignSystem constants (never hard-code colors, spacing, fonts)
- Follow MVVM pattern strictly
- Handle errors with user-friendly messages
- Preserve clinical context in anonymization
- Never write to disk
- Test before proceeding to next phase

### Never
- Hard-code design values
- Skip phase verification
- Auto-save or persist sensitive data
- Upload anything to cloud
- Proceed without explicit approval

---

## Current Status

**Active Phase:** ✅ Phase 1 Complete - Phase 2 Ready to Begin
**Next Milestone:** Complete Phase 2 (Setup Flow & Ollama Integration)
**Blockers:** None

### Phase 1 Completed ✅
- [x] Xcode project created (Redactor.xcodeproj via xcodegen)
- [x] Folder structure organized
- [x] Fonts downloaded and integrated (Lora + Source Sans 3)
- [x] DesignSystem.swift implemented with macOS compatibility
- [x] AppError.swift created with comprehensive error handling
- [x] Assets.xcassets configured
- [x] Info.plist configured with fonts
- [x] Project builds successfully via CLI
- [x] App runs in Xcode with custom fonts rendering
- [x] All changes committed to git

### Phase 2 Ready (Next)
**Setup Flow & Ollama Integration**

Files to Create:
1. Utilities/SetupManager.swift (Ollama detection and installation)
2. Views/SetupView.swift (Setup wizard UI)
3. Services/OllamaService.swift (HTTP communication with Ollama)
4. Update ClinicalAnonApp.swift (conditional view rendering)

Goals:
- Working setup wizard with all states
- Ollama detection and installation flow
- HTTP communication foundation ready

---

## Questions & Clarifications

If uncertain about:
- **Implementation details** → Check main specification
- **File structure** → Check Phase-Documents-Checklist.md
- **Phase goals** → Check Implementation-Plan.md
- **Design values** → Check DesignSystem.swift (after created)
- **Architecture patterns** → Check this file (Common Patterns section)

Always ask before deviating from:
- Architecture patterns
- Privacy model
- Phase order
- Coding standards

---

## Success Criteria

### Phase 1 Complete When:
- [ ] Xcode project builds without errors
- [ ] Custom fonts render in SwiftUI preview
- [ ] DesignSystem colors display correctly
- [ ] Can create views using DesignSystem constants
- [ ] AppError types can be thrown and caught

### MVP Complete When:
- [ ] Setup wizard guides through Ollama installation
- [ ] Can anonymize clinical text with LLM
- [ ] Highlighting shows entities correctly
- [ ] Consistent entity mapping works
- [ ] Clinical context preserved
- [ ] Copy to clipboard works
- [ ] No data written to disk
- [ ] Clear error messages
- [ ] Stable and responsive UI

---

*This context file is maintained throughout development. Update as decisions are made or context changes.*
